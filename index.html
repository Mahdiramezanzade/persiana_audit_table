
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Persiana Audit Program Monthly</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      padding: 2rem;
    }
    h1 {
      text-align: center;
      margin-bottom: 2rem;
    }
    .upload-container {
      text-align: center;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1e1e1e;
      margin-top: 2rem;
    }
    th, td {
      border: 1px solid #444;
      padding: 0.75rem;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #ffcc00;
    }
    tr:nth-child(even) {
      background-color: #2a2a2a;
    }
    .chart-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 2rem;
      margin: 2rem auto;
    }
    .chart-container {
      flex: 1 1 400px;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <h1>Persiana Audit Program Monthly</h1>

  <div class="upload-container">
    <input type="file" id="upload" accept=".xlsx" />
  </div>

  <div class="chart-row">
    <div class="chart-container">
      <canvas id="barChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="pieChart"></canvas>
    </div>
  </div>

  <div id="tableContainer"></div>

  <script>
    const uploadInput = document.getElementById('upload');
    const pieColors = [
      '#FF6384', '#36A2EB', '#FFCE56',
      '#4BC0C0', '#9966FF', '#FF9F40',
      '#00D084', '#F67019', '#8884d8', '#00C49F'
    ];

    uploadInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        renderTable(jsonData);
        renderCharts(jsonData);
      };
      reader.readAsArrayBuffer(file);
    });

    function renderTable(data) {
      const tableContainer = document.getElementById('tableContainer');
      let html = "<table><thead><tr>";
      const headerRow = data.find(row => row.includes("Department"));
      if (!headerRow) return;
      headerRow.forEach(col => html += `<th>${col || ''}</th>`);
      html += "</tr></thead><tbody>";

      data.forEach((row, i) => {
        if (i === 0 || row.length < 2 || row.every(cell => !cell)) return;
        if (i <= data.indexOf(headerRow)) return;
        html += "<tr>";
        row.forEach(cell => html += `<td>${cell !== undefined ? cell : '-'}</td>`);
        html += "</tr>";
      });

      html += "</tbody></table>";
      tableContainer.innerHTML = html;
    }

    function renderCharts(data) {
      const headerRowIndex = data.findIndex(row => row.includes("Department"));
      const labels = [], salaries = [], totals = [];

      for (let i = headerRowIndex + 1; i < data.length; i++) {
        const row = data[i];
        const dept = row[1];
        const salary = parseFloat(row[2]);
        const total = parseFloat(row[10]);

        if (dept && !isNaN(salary) && !isNaN(total)) {
          labels.push(dept);
          salaries.push(salary);
          totals.push(Math.abs(total));
        }
      }

      if (window.barChart) window.barChart.destroy();
      if (window.pieChart) window.pieChart.destroy();

      const barCtx = document.getElementById('barChart').getContext('2d');
      window.barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Personnel Salaries',
            data: salaries,
            backgroundColor: pieColors.slice(0, labels.length),
            borderColor: '#000',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      const pieCtx = document.getElementById('pieChart').getContext('2d');
      window.pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Cost Distribution',
            data: totals,
            backgroundColor: pieColors.slice(0, labels.length)
          }]
        },
        options: {
          responsive: true
        }
      });
    }
  </script>
</body>
</html>
